
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>simlib.framework.structure &#8212; simlib 0.0.34 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">simlib 0.0.34 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">simlib.framework.structure</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for simlib.framework.structure</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">structure.py</span>
<span class="sd">written in Python3</span>
<span class="sd">author: C. Lockhart &lt;chris@lockhartlab.org&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">simlib.analysis.protein.hydrophobicity</span> <span class="kn">import</span> <span class="n">rmsd</span>
<span class="kn">from</span> <span class="nn">simlib.external</span> <span class="kn">import</span> <span class="n">stride</span>
<span class="kn">from</span> <span class="nn">.errata</span> <span class="kn">import</span> <span class="n">pivot</span>

<span class="kn">from</span> <span class="nn">glovebox</span> <span class="kn">import</span> <span class="n">GloveBox</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># os.environ[&quot;MODIN_ENGINE&quot;] = &#39;dask&#39;</span>
<span class="c1"># import modin.pandas as pd</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="c1"># Structure class</span>
<div class="viewcode-block" id="Structure"><a class="viewcode-back" href="../../../api/generated/simlib.framework.Structure.html#simlib.framework.Structure">[docs]</a><span class="k">class</span> <span class="nc">Structure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A `Structure` is an object that stores a single three-dimensional &quot;structure&quot;</span>

<span class="sd">    &quot;Structure&quot; can be used loosely here because it applies to proteins, proteins in water baths, proteins in lipid</span>
<span class="sd">    environments, ligands in water, etc.</span>

<span class="sd">    The `Structure` instance generally follows PDB format [1] in that in contains,</span>
<span class="sd">      - id</span>
<span class="sd">      - x</span>
<span class="sd">      - y</span>
<span class="sd">      - z</span>
<span class="sd">      - alpha</span>
<span class="sd">      - beta</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Required columns</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;atom_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;atom&#39;</span><span class="p">,</span>
        <span class="s1">&#39;residue&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chain&#39;</span><span class="p">,</span>
        <span class="s1">&#39;residue_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="s1">&#39;y&#39;</span><span class="p">,</span>
        <span class="s1">&#39;z&#39;</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">,</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">,</span>
        <span class="s1">&#39;segment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;element&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Initialize class instance</span>
<div class="viewcode-block" id="Structure.__init__"><a class="viewcode-back" href="../../../api/generated/simlib.framework.Structure.html#simlib.framework.Structure.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize class instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO should this be protected?</span>
        <span class="c1"># Save data or create blank DataFrame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Construct topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># Add</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add constant to Cartesian coordinates of Structure instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">+=</span> <span class="n">other</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Get attribute</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in Structure&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Get atom from Structure by index</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        item</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Make sure that item a valid atom_id</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;atom_id&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not a valid atom_id&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>

        <span class="c1"># Create copy of the row</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;atom_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Sanity</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;multiple atom_id </span><span class="si">%s</span><span class="s1"> found in Structure&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>

        <span class="c1"># Return (as Series)</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Length of structure (returns number of atoms)</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of atoms in the Structure instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Number of atoms in the Structure instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="c1"># Add new atoms from list</span>
<div class="viewcode-block" id="Structure.add_atoms"><a class="viewcode-back" href="../../../api/generated/simlib.framework.Structure.html#simlib.framework.Structure.add_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">add_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># _add_atoms(self.data, self.columns, kwargs)</span>
        <span class="k">pass</span></div>

    <span class="c1"># Apply</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># TODO is this too specific? Evaluate if Structure should be more generalized</span>
    <span class="c1"># Compute secondary structure</span>
    <span class="k">def</span> <span class="nf">compute_secondary_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;stride&#39;</span><span class="p">):</span>
        <span class="c1"># If secondary_structure is not in the Structure, or recompute is true, compute</span>
        <span class="k">if</span> <span class="s1">&#39;secondary_structure&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">or</span> <span class="n">recompute</span><span class="p">:</span>
            <span class="c1"># TODO in lieu of directly porting stride to Python, how can this be sped up?</span>
            <span class="c1"># Write out PDB of structure to glovebox</span>
            <span class="n">gb</span> <span class="o">=</span> <span class="n">GloveBox</span><span class="p">(</span><span class="s1">&#39;simlib-stride&#39;</span><span class="p">,</span> <span class="n">persist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">temp_pdb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gb</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;temp.pdb&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_pdb</span><span class="p">(</span><span class="n">temp_pdb</span><span class="p">)</span>

            <span class="c1"># Run STRIDE</span>
            <span class="n">secondary_structure</span> <span class="o">=</span> <span class="n">stride</span><span class="p">(</span><span class="n">temp_pdb</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">)[[</span><span class="s1">&#39;residue_id&#39;</span><span class="p">,</span> <span class="s1">&#39;secondary_structure&#39;</span><span class="p">]]</span>

            <span class="c1"># Clean glovebox</span>
            <span class="n">gb</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

            <span class="c1"># Drop secondary_structure if it&#39;s already in self._data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;secondary_structure&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

            <span class="c1"># Merge STRIDE results with Structure to store</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">secondary_structure</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;residue_id&#39;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s1">&#39;m:1&#39;</span><span class="p">)</span>

        <span class="c1"># Return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[[</span><span class="s1">&#39;residue_id&#39;</span><span class="p">,</span> <span class="s1">&#39;secondary_structure&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># Copy</span>
<div class="viewcode-block" id="Structure.copy"><a class="viewcode-back" href="../../../api/generated/simlib.framework.Structure.html#simlib.framework.Structure.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a copy of Structure instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        simlib.Structure</span>
<span class="sd">            Copy of instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

    <span class="c1"># Pivot</span>
    <span class="k">def</span> <span class="nf">pivot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pivot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">aggfunc</span><span class="p">)</span>

    <span class="c1"># TODO should this return a Structure or Trajectory? TBD</span>
    <span class="c1"># TODO what if there were an intermediate object, like a Query class that knew how to handle subindexing / setting</span>
    <span class="c1"># Query</span>
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># TODO make this so it&#39;s customizable</span>
        <span class="c1"># Run macros</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;peptide&#39;</span><span class="p">,</span> <span class="s1">&#39;residue in [&quot;ALA&quot;, &quot;ARG&quot;, &quot;ASN&quot;, &quot;ASP&quot;, &quot;CYS&quot;, &quot;GLN&quot;, &quot;GLU&quot;, &quot;GLY&quot;, &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;&quot;HIS&quot;, &quot;HSD&quot;, &quot;ILE&quot;, &quot;LEU&quot;, &quot;LYS&quot;, &quot;MET&quot;, &quot;PHE&quot;, &quot;PRO&quot;, &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;&quot;SER&quot;, &quot;THR&quot;, &quot;TRP&quot;, &quot;TYR&quot;, &quot;VAL&quot;]&#39;</span><span class="p">)</span>

        <span class="c1"># Get indices and parsed data</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="p">:]</span>

        <span class="c1"># If self is Trajectory, return a Trajectory</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Trajectory</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Return to user</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># TODO extend this to another trajecotry</span>
    <span class="c1"># Compute RMSD</span>
<div class="viewcode-block" id="Structure.rmsd"><a class="viewcode-back" href="../../../api/generated/simlib.framework.Structure.html#simlib.framework.Structure.rmsd">[docs]</a>    <span class="k">def</span> <span class="nf">rmsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute root-mean-square deviation (RMSD) with another structure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        structure :</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">rmsd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span></div>

    <span class="c1"># Set topology</span>
<div class="viewcode-block" id="Structure.set_topology"><a class="viewcode-back" href="../../../api/generated/simlib.framework.Structure.html#simlib.framework.Structure.set_topology">[docs]</a>    <span class="k">def</span> <span class="nf">set_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set topology</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topology : Topology</span>
<span class="sd">            Instance of Topology class</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span></div>

    <span class="c1"># Write to CSV</span>
    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># Save as PDB</span>
<div class="viewcode-block" id="Structure.to_pdb"><a class="viewcode-back" href="../../../api/generated/simlib.framework.Structure.html#simlib.framework.Structure.to_pdb">[docs]</a>    <span class="k">def</span> <span class="nf">to_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_or_buffer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename_or_buffer</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a copy of the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Add ATOM record</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ATOM&#39;</span>

        <span class="c1"># TODO this should also be done for residue id probably</span>
        <span class="c1"># Change base-0 to base-1 for atom_id</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;atom_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;atom_id&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Format atom</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;atom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;atom&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;atom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;atom&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

        <span class="c1"># Select pertinent columns</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;record&#39;</span><span class="p">,</span> <span class="s1">&#39;atom_id&#39;</span><span class="p">,</span> <span class="s1">&#39;atom&#39;</span><span class="p">,</span> <span class="s1">&#39;residue&#39;</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;residue_id&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;segment&#39;</span><span class="p">,</span> <span class="s1">&#39;element&#39;</span><span class="p">]]</span>

        <span class="c1"># Write out PDB file</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
            <span class="n">filename_or_buffer</span><span class="p">,</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%-6s%5i</span><span class="s1"> </span><span class="si">%4s%4s%2s%4i%12.3f%8.3f%8.3f%6.2f%6.2f%9s%2s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="s1">&#39;CRYST1    0.000    0.000    0.000  90.00  90.00  90.00 P 1           1&#39;</span><span class="p">,</span>
            <span class="n">footer</span><span class="o">=</span><span class="s1">&#39;END&#39;</span><span class="p">,</span>
            <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="p">)</span></div>

    <span class="c1"># Convert to trajectory</span>
    <span class="k">def</span> <span class="nf">to_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Create and/or update structure_id if necessary</span>
        <span class="k">if</span> <span class="s1">&#39;structure_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="n">structure_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">structure_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;structure_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure_id</span>

        <span class="c1"># Return Trajectory</span>
        <span class="k">return</span> <span class="n">Trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="c1"># Get coordinates</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span></div>


<span class="c1"># Trajectory cannot simply be a list of Structures</span>
<span class="c1"># class Trajectory(Structure):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     # Initialize instance of Trajectory class</span>
<span class="c1">#     # noinspection PyMissingConstructor</span>
<span class="c1">#     def __init__(self, data=None):</span>
<span class="c1">#         if isinstance(data, pd.DataFrame):</span>
<span class="c1">#             self._data = data</span>
<span class="c1">#</span>
<span class="c1">#     # Get Structure from Trajectory</span>
<span class="c1">#     def __getitem__(self, item):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#         Parameters</span>
<span class="c1">#         ----------</span>
<span class="c1">#         item</span>
<span class="c1">#</span>
<span class="c1">#         Returns</span>
<span class="c1">#         -------</span>
<span class="c1">#</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#         # Convert item to integer array if not already</span>
<span class="c1">#         item = np.array(item, dtype=&#39;int&#39;).reshape(-1)</span>
<span class="c1">#         if len(item) not in [1, 2]:</span>
<span class="c1">#             raise AttributeError(&#39;index must be structure_id or list with [structure_id, atom_id]&#39;)</span>
<span class="c1">#</span>
<span class="c1">#         # First, get structure</span>
<span class="c1">#         result = self.get_structure(item[0])</span>
<span class="c1">#</span>
<span class="c1">#         # If there&#39;s a second dimension, get an atom</span>
<span class="c1">#         if len(item) == 2:</span>
<span class="c1">#             result = result[item[1]]</span>
<span class="c1">#</span>
<span class="c1">#         # Return</span>
<span class="c1">#         return result</span>
<span class="c1">#</span>
<span class="c1">#     # Get number of structures in Trajectory</span>
<span class="c1">#     def __len__(self):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Number of structures in Trajectory.</span>
<span class="c1">#</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#         return self._data[&#39;structure_id&#39;].nunique()</span>
<span class="c1">#</span>
<span class="c1">#     # Add a structure</span>
<span class="c1">#     # noinspection PyProtectedMember</span>
<span class="c1">#     def add_structure(self, structure):</span>
<span class="c1">#         structure._data[&#39;structure_id&#39;] = self._data[&#39;structure_id&#39;].max() + 1</span>
<span class="c1">#         self._data = pd.concat([self._data, structure._data])</span>
<span class="c1">#</span>
<span class="c1">#     # TODO this can be parallelized</span>
<span class="c1">#     # Apply</span>
<span class="c1">#     def apply(self, function):</span>
<span class="c1">#         result = None</span>
<span class="c1">#         for structure_id in self._data[&#39;structure_id&#39;].unique():</span>
<span class="c1">#             # Run the apply function from the Structure with structure_id</span>
<span class="c1">#             result_ = self.get_structure(structure_id).apply(function)</span>
<span class="c1">#</span>
<span class="c1">#             # If the result is a series, convert to frame and use structure_id as the index</span>
<span class="c1">#             if isinstance(result_, pd.Series):</span>
<span class="c1">#                 result_ = result_.to_frame().T</span>
<span class="c1">#                 result_.index = [structure_id]</span>
<span class="c1">#                 result_.index.name = &#39;structure_id&#39;</span>
<span class="c1">#</span>
<span class="c1">#             if result is None:</span>
<span class="c1">#                 result = result_</span>
<span class="c1">#             else:</span>
<span class="c1">#                 if isinstance(result, pd.DataFrame):</span>
<span class="c1">#                     result = pd.concat([result, result_])</span>
<span class="c1">#                 elif isinstance(result, list):</span>
<span class="c1">#                     result.append(result_)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     result = [result, result_]</span>
<span class="c1">#</span>
<span class="c1">#         return result</span>
<span class="c1">#</span>
<span class="c1">#     # TODO this can be parallelized</span>
<span class="c1">#     # Compute secondary structure</span>
<span class="c1">#     def compute_secondary_structure(self, recompute=False, executable=&#39;stride&#39;):</span>
<span class="c1">#         for structure_id in self._data[&#39;structure_id&#39;].unique():</span>
<span class="c1">#             self.get_structure(structure_id).compute_secondary_structure(recompute=recompute, executable=executable)</span>
<span class="c1">#</span>
<span class="c1">#     # Get structure</span>
<span class="c1">#     def get_structure(self, structure_id):</span>
<span class="c1">#         # Make sure structure_id is an array</span>
<span class="c1">#         structure_id = np.array(structure_id, dtype=&#39;int&#39;).reshape(-1)</span>
<span class="c1">#</span>
<span class="c1">#         # Parse DataFrame for appropriate rows and return as Structure</span>
<span class="c1">#         return Structure(self._data.loc[self._data[&#39;structure_id&#39;].isin(structure_id), :])</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">simlib 0.0.34 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">simlib.framework.structure</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Lockhart Lab.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.1.2.
    </div>
  </body>
</html>